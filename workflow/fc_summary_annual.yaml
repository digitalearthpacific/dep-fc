kind: Workflow
metadata:
  generateName: fc-summary-annual-84-24-
  namespace: argo
spec:
  entrypoint: loop-map
  serviceAccountName: open-data-bucket-writer
  podGC:
    strategy: OnPodSuccess
    deleteDelayDuration: 600s
  parallelism: 300 
  podMetadata:
    labels:
      app: fc
    annotations:
      karpenter.sh/do-not-disrupt: "true"
  nodeSelector:
    karpenter.sh/capacity-type: "spot"
  hostAliases:
    - ip: "52.94.181.70"
      hostnames:
        - "sts.us-west-2.amazonaws.com"
    - ip: "52.92.251.106"
      hostnames:
        - "dep-public-staging.s3.us-west-2.amazonaws.com"
    - ip: "52.92.160.242"
      hostnames:
        - "dep-public-data.s3.us-west-2.amazonaws.com"
  arguments:
    parameters:
    - name: version
      value: "0.1.1" 
    - name: image-tag
      value: "0.1.0rc7"
  templates:
  - name: loop-map
    retryStrategy:
      limit: "2"
      retryPolicy: "OnError"
    dag:
      tasks:
        - name: generate-ids
          template: generate
          arguments:
            parameters:
              - name: limit
                value: "9999"
              - name: years
                value: "1984_2024"
              - name: version
                value: "{{ workflow.parameters.version }}"
              - name: datasetid
                value: "fc_summary_annual"
              - name: overwrite-existing-log
                value: "False"
        - name: process-id
          depends: generate-ids.Succeeded
          template: process-tile
          arguments:
            parameters:
            - name: column
              value: "{{item.column}}"
            - name: row
              value: "{{item.row}}"
            - name: datetime
              value: "{{item.year}}"
            - name: version
              value: "{{ workflow.parameters.version }}"
            - name: raise_empty_collection_error
              value: "False"
          withParam: "{{ tasks.generate-ids.outputs.result }}"
  - name: generate
    inputs:
      parameters:
      - name: limit
      - name: years
      - name: version
      - name: datasetid
      - name: overwrite-existing-log
    container:
      image: "ghcr.io/digitalearthpacific/dep-fc:{{ workflow.parameters.image-tag }}"
      imagePullPolicy: IfNotPresent
      resources:
        requests: 
          memory: 100Mi
          cpu: 1.0
      command: [ "uv", "run" ]
      args:
        - list.py
        - --years
        - "{{ inputs.parameters.years }}"
        - --version
        - "{{ inputs.parameters.version }}"
        - --limit
        - "{{ inputs.parameters.limit }}"
        - --grid
        - "dep"
        - --dataset-id
        - "{{ inputs.parameters.datasetid }}"
        - --overwrite-existing-log
        - "{{ inputs.parameters.overwrite-existing-log }}"
  - name: process-tile
    inputs:
      parameters:
      - name: column
      - name: row
      - name: datetime
      - name: version
      - name: raise_empty_collection_error
    container:
      image: "ghcr.io/digitalearthpacific/dep-fc:{{ workflow.parameters.image-tag }}"
      imagePullPolicy: IfNotPresent
      resources:
        requests: 
          cpu: 4
          memory: 32Gi
        limits:
          cpu: 8
          memory: 64Gi
      command: [ "uv", "run" ]
      args:
        - create_annual_summary.py
        - --column
        - "{{ inputs.parameters.column }}"
        - --row
        - "{{ inputs.parameters.row }}"
        - --datetime
        - "{{ inputs.parameters.datetime }}"
        - --version
        - "{{ inputs.parameters.version }}"
        - --raise-empty-collection-error
        - "{{ inputs.parameters.raise_empty_collection_error }}"
